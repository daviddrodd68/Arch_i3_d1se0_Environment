#!/usr/bin/env bash

WALL_DIR="$HOME/.wallpapers"
XPROFILE="$HOME/.config/x11/xprofile"
MARKER="# Wallpaper + colors (UNICA fuente de verdad)"

command -v wal >/dev/null || { echo "‚ùå wal no est√° instalado"; exit 1; }
[ -d "$WALL_DIR" ] || { echo "‚ùå No existe $WALL_DIR"; exit 1; }
[ -f "$XPROFILE" ] || { echo "‚ùå No existe $XPROFILE"; exit 1; }

clear
echo "üñºÔ∏è  Fondos disponibles en $WALL_DIR"
echo "----------------------------------"

mapfile -t WALLS < <(ls -1 "$WALL_DIR")

if [ "${#WALLS[@]}" -eq 0 ]; then
    echo "‚ùå No hay fondos en $WALL_DIR"
    exit 1
fi

for i in "${!WALLS[@]}"; do
    printf " [%d] %s\n" "$i" "${WALLS[$i]}"
done

echo
read -rp "üëâ Elige un fondo (n√∫mero): " choice

if ! [[ "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -ge "${#WALLS[@]}" ]; then
    echo "‚ùå Selecci√≥n inv√°lida"
    exit 1
fi

WALL="$WALL_DIR/${WALLS[$choice]}"

echo
echo "üé® Aplicando wal con: $WALL"
wal -i "$WALL" || exit 1

# 1Ô∏è‚É£ Eliminar cualquier wal previo
sed -i '/^[[:space:]]*wal -i/d' "$XPROFILE"

# 2Ô∏è‚É£ Insertar wal justo debajo del marcador
if grep -qF "$MARKER" "$XPROFILE"; then
    sed -i "/$MARKER/a wal -i \"$WALL\"" "$XPROFILE"
else
    echo "‚ùå No se encontr√≥ el marcador en xprofile"
    exit 1
fi

echo
echo "‚úÖ Fondo y colores actualizados"
echo "‚ôªÔ∏è ENecesario reiniciar 'sudo reboot'"
